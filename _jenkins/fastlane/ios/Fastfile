# Author: æ½˜ç»´å‰
# Description: è‡ªå®šä¹‰æ ¸å¿ƒFastlaneé…ç½®æ–‡ä»¶ å®ç°åŸç”ŸiOSå…¨è‡ªåŠ¨CI/CDæµæ°´çº¿
# cd *.xcodeprojå·¥ç¨‹ç›®å½• && fastlane beta

import "../GeneralFastfile"

default_platform(:ios)

#å£°æ˜å˜é‡  å®šä¹‰å…¨å±€å‚æ•° å¤§å†™å¼€å¤´ä¸ºå¸¸æ•°,å°å†™ã€_å¼€å¤´ä¸ºå˜é‡,$å¼€å¤´ä¸ºå…¨å±€å˜é‡(ç›´æ¥ç”¨#è®¿é—®)
APP_IDENTIFIER = ENV['APP_IDENTIFIER']
APPLE_ID = ENV['APPLE_ID']
TEAM_ID = ENV['TEAM_ID']
SCHEME = ENV['SCHEME']
XC_WORKSPACE = ENV['XC_WORKSPACE']
XC_PROJECT = ENV['XC_PROJECT']
APP_INFO_PLIST_PATH = ENV['APP_INFO_PLIST_PATH']
OUTPUT_DIRECTORY = ENV['OUTPUT_DIRECTORY']

#IPA_TIME = Time.now.strftime("%Y-%m-%d_%H:%M")
# ipaå®‰è£…åŒ…è·¯å¾„
IPA_PATH = ""
# è¯ä¹¦å’Œç­¾åæ–‡ä»¶å½’æ¡£ç›®å½•
SIGN_ARCHIVE_DIR = "./archive/sign"

platform :ios do

  #åœ¨æ‰§è¡Œlaneä¹‹å‰åªæ‰§è¡Œä¸€æ¬¡
  before_all do |lane, options|

    #åˆ¤æ–­æ˜¯å¦æ˜¯ciç¯å¢ƒ
    # Make sure we have certs and provisioning profiles
    if is_ci
      puts "I'm a CI"
      #å®ç°æ›´è½»æ¾çš„Jenkinsé›†æˆ
      setup_jenkins
      # If running on CI, uses a separate keychain
      # setup_keychain_for_ci(signing_type: options[:sign_type])
    else
      say "I'm a Human"
      # If running on a user's machine, uses the default keychain
      # setup_keychain(signing_type: options[:sign_type])
    end

    # App Store Connect API æ˜¯æ–°çš„ç”¨äºç®¡ç†åº”ç”¨ç¨‹åºçš„å…ƒæ•°æ®ï¼Œä»·æ ¼å’Œå¯ç”¨æ€§ï¼Œé…ç½®å’Œæ›´æ­£å¼çš„å…¬å…±API ä½¿ç”¨APIå¯†é’¥æ¥ç”ŸæˆJWTè®¿é—®
    # è¿‡å»ï¼Œfastlaneä¸€ç›´ä½¿ç”¨å¸¦æœ‰ç”¨æˆ·åå’Œå¯†ç çš„Apple IDæ¥é€šè¿‡åŸºäºcookieçš„Webä¼šè¯è¿›è¡Œèº«ä»½éªŒè¯
    # å¥½å¤„ï¼š1. æ— éœ€2FAä¸¤æ­¥è®¤è¯ 2. æ›´å¥½çš„æ€§èƒ½ 3. è®°å½•çš„API 4. æ›´é«˜çš„å¯é æ€§
    # æ–‡æ¡£: http://docs.fastlane.tools/app-store-connect-api/  è·å–åœ°å€: https://appstoreconnect.apple.com/access/api
    key_file_path = ENV['HOME'] + ENV['CONNECT_API_KEY_FILE_PATH'] # p8æ–‡ä»¶è·¯å¾„
    app_store_connect_api_key(
      key_id: ENV['CONNECT_API_KEY_ID'],
      issuer_id: ENV['CONNECT_API_ISSUER_ID'],
      key_filepath: key_file_path, # ä¸€ä¸ªp8æ–‡ä»¶ï¼Œæœ€å¥½ä¿å­˜åœ¨æœåŠ¡å™¨ä¸Šï¼Œä¸è¦æ³„æ¼
      duration: 1200, # ä¼šè¯æ—¶é•¿ï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œæœ€å¤§ä¸º1200
      in_house: false, # å¦‚æœå›¢é˜Ÿæ˜¯Enterpriseæˆ–ä¸æ˜¯Enterprise
    )

    # è·å–ä»£ç å†…çš„ç‰ˆæœ¬å·
    APP_VERSION = get_version_number(target: "#{SCHEME}")
    # APP_BUILD_VERSION = get_build_number(xcodeproj: "#{XC_PROJECT}")
    # puts "#{APP_VERSION}"
    # puts "#{APP_BUILD_VERSION}"
    # è‡ªå®šä¹‰ç‰ˆæœ¬å·
    customVersion = options[:version_num]
    # .nil? å’Œ .empty? æ˜¯rubyçš„æ–¹æ³•ã€‚ .blank? æ˜¯rails(å®‰è£…sudo gem install rails && rails -v)çš„æ–¹æ³• .blank? ç›¸å½“äºåŒæ—¶æ»¡è¶³ .nil? å’Œ .empty?
    unless customVersion.nil? || customVersion.empty?
      puts "\033[32mè‡ªå®šä¹‰è®¾ç½®iOS APPç‰ˆæœ¬å·: \033[0m" + customVersion
      APP_VERSION = customVersion # ä¸ä»ä»£ç å†…è·å–çš„æƒ…å†µ
    end
    # ç¡®ä¿è¿è¡Œå¿«é€Ÿé€šé“æ—¶fastlaneå·¥å…·æ˜¯æœ€æ–°çš„
    # update_fastlane
    # å¦‚æœæœ‰æœªæäº¤çš„gitæ›´æ”¹ï¼Œåˆ™ä¼šå¼•å‘å¼‚å¸¸
    # sure_git_status_clean
    # å®‰è£…æ‰€æœ‰æ’ä»¶å’Œæ›´æ–°æ‰€æœ‰æ’ä»¶
    # sh "fastlane install_plugins"
    # sh "fastlane update_plugins"
    # å…·ä½“å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„xcodeå’ŒåŠ¨æ€é€‰æ‹©Xcodeç‰ˆæœ¬
    # (version: "12.5")
    # xcversion(version: "~> 12.5")

    # ä½¿ç”¨ç¯å¢ƒå˜é‡æä¾›è¿™ä¸ªå¯†ç ç»™fastlaneï¼Œè§£å†³åŒé‡è®¤è¯ç”Ÿæˆçš„ç‰¹æ®Šå¯†ç 
    #ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = "iire-nvtq-ywlv-shah"
    #optionså‚æ•° fastlane beta key:value key2:value2
    #value = options[:key]

  end

  desc "iOSæ‰“åŒ…"
  lane :package do |options|
    PACKAGING_TYPE = options[:packaging_type]
    EXPORT_METHOD = options[:sign_type] # developmentã€ad-hoc

    # å®šä¹‰åŒ…å
    IPA_NAME = "#{SCHEME}-" + "v#{APP_VERSION}-" + "#{PACKAGING_TYPE}-#{EXPORT_METHOD}" + "-#{Time.now.strftime("%Y-%m-%d_%H:%M")}" + ".ipa"

    # è®¾ç½®åº”ç”¨ç‰ˆæœ¬å·
    increment_version_number(
      #bump_type: "patch", # Automatically increment patch version number
      version_number: "#{APP_VERSION}", # specify specific version number (optional, omitting it increments patch version number)
      xcodeproj: "./#{XC_PROJECT}" # (optional, you must specify the path to your main Xcode project if it is not in the project root directory)
    )

    if options[:sign_type] == 'development'

      puts "\033[33mè‡ªåŠ¨ä»è‹¹æœå¼€å‘è€…å¹³å°ä¸‹è½½æ›´æ–°developmentç­¾åç±»å‹çš„p12è¯ä¹¦å’Œmobileprovisionæ–‡ä»¶ è‡ªåŠ¨ç­¾åé…ç½®ç¯å¢ƒ\033[0m"
      get_certificates(
        development: true,
        output_path: "#{SIGN_ARCHIVE_DIR}", # æŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶å¤¹åœ°å€
        # keychain_path: ENV['HOME'] + "/Library/Keychains/login.keychain-db",
        keychain_password: ENV['MACOS_USER_PASSWORD'] # ç¬¬ä¸€æ¬¡åœ¨æ–°Macä¸Šè®¿é—®è¯ä¹¦æ—¶éœ€è¦ã€‚å¯¹äºç™»å½•/é»˜è®¤é’¥åŒ™ä¸²ï¼ŒmacOS å¸æˆ·å¯†ç 
      )
      get_provisioning_profile(
        development: true,
        #force: true, # æ¯æ¬¡éƒ½æ›´æ–°
        output_path: "#{SIGN_ARCHIVE_DIR}", # æŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶å¤¹åœ°å€
        filename: "#{APP_IDENTIFIER}.#{EXPORT_METHOD}.mobileprovision"
      )

      # æ„å»ºæ‰“åŒ…
      packaging(configuration: "#{PACKAGING_TYPE}") # Releaseã€Debug
    elsif options[:sign_type] == 'ad-hoc'

      puts "\033[33mè‡ªåŠ¨ä»è‹¹æœå¼€å‘è€…å¹³å°ä¸‹è½½æ›´æ–°ad-hocç­¾åç±»å‹çš„p12è¯ä¹¦å’Œmobileprovisionæ–‡ä»¶ è‡ªåŠ¨ç­¾åé…ç½®ç¯å¢ƒ\033[0m"
      get_certificates(
        output_path: "#{SIGN_ARCHIVE_DIR}", # æŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶å¤¹åœ°å€
        keychain_password: ENV['MACOS_USER_PASSWORD'] # ç¬¬ä¸€æ¬¡åœ¨æ–°Macä¸Šè®¿é—®è¯ä¹¦æ—¶éœ€è¦ã€‚å¯¹äºç™»å½•/é»˜è®¤é’¥åŒ™ä¸²ï¼ŒmacOS å¸æˆ·å¯†ç 
      )
      get_provisioning_profile(
        adhoc: true, # æ˜¯å¦ä¸º AdHoc è¯ä¹¦ï¼ˆè®¾ä¸º false æˆ–ä¸å†™é»˜è®¤ä¸º AppStore è¯ä¹¦ï¼‰
        force: true, # æ¯æ¬¡éƒ½æ›´æ–° åŒæ­¥æ‰€æœ‰è®¾å¤‡ä¿¡æ¯åˆ°mobileprovisionæ–‡ä»¶
        output_path: "#{SIGN_ARCHIVE_DIR}", # æŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶å¤¹åœ°å€
        filename: "#{APP_IDENTIFIER}.#{EXPORT_METHOD}.mobileprovision"
      )

      # æ„å»ºæ‰“åŒ…
      packaging(configuration: "#{PACKAGING_TYPE}") # Releaseã€Debug
    elsif options[:sign_type] == 'app-store'

      puts "\033[33mè‡ªåŠ¨ä»è‹¹æœå¼€å‘è€…å¹³å°ä¸‹è½½æ›´æ–°app-storeç­¾åç±»å‹çš„p12è¯ä¹¦å’Œmobileprovisionæ–‡ä»¶ è‡ªåŠ¨ç­¾åé…ç½®ç¯å¢ƒ\033[0m"
      get_certificates
      get_provisioning_profile(
        #force: true, # æ¯æ¬¡éƒ½æ›´æ–°
        output_path: "#{SIGN_ARCHIVE_DIR}", # æŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶å¤¹åœ°å€
        filename: "#{APP_IDENTIFIER}.#{EXPORT_METHOD}.mobileprovision"
      )

      # æ„å»ºå®¡æ ¸ä¸Šæ¶å‰å¯ä»¥å…ˆå¯¹æ¯”æœ¬åœ°ç‰ˆæœ¬æ˜¯å¦é«˜äºçº¿ä¸Šç‰ˆæœ¬

      # å°†å€¼è®¾ç½®ä¸ºé¡¹ç›®çš„Info.plist
=begin
      if (options[:version_num])
        set_info_plist_value(path: "#{APP_INFO_PLIST_PATH}", key: "CFBundleShortVersionString", value: options[:version_num])
        APP_VERSION = options[:version_num]
      end
=end

      # è®¾ç½®æ„å»ºå· æ ¹æ®çº¿ä¸Šç‰ˆæœ¬è‡ªåŠ¨é€’å¢
      increment_build_number(
        build_number: latest_testflight_build_number.to_f + 1, # specify specific build number (optional, omitting it increments by one)
        xcodeproj: "./#{XC_PROJECT}" # (optional, you must specify the path to your main Xcode project if it is not in the project root directory)
      )
      # æ„å»ºæ‰“åŒ…
      packaging(configuration: "#{PACKAGING_TYPE}") # Releaseã€Debug

    else
      puts "\033[33miOSæ‰“åŒ…ç­¾åæ–¹å¼ä¸æ­£ç¡® âŒ\033[0m"
    end
  end

  desc "æ„å»ºæ‰“åŒ…æ–¹æ³•"
  private_lane :packaging do |option|
    # å¼€å§‹æ‰“åŒ…ä¹‹å‰çš„æ‰§è¡Œä»»åŠ¡
    package_before_do()

    puts "\033[32må¼€å§‹iOSæ‰“åŒ…IPA\033[0m\n"
    puts "#{APP_IDENTIFIER}"

    #æ‰“åŒ…gym
    IPA_PATH = build_app(
      workspace: "#{XC_WORKSPACE}", #æŒ‡å®š.xcworkspaceæ–‡ä»¶çš„è·¯å¾„(ä½¿ç”¨cocopodsæ–¹å¼  pod installåç”Ÿæˆ.xcworkspaceç›®å½•)
      scheme: "#{SCHEME}", #æŒ‡å®šæ‰“çš„å“ªä¸ªscheme å¤šTargetæ‰“åŒ…éœ€è¦æŒ‡å®šå…·ä½“å…³è”çš„scheme  Make sure it's marked as Shared
      clean: true, # "#{EXPORT_METHOD == "app-store" ? true : false }", #æ‰“åŒ…å‰æ˜¯å¦æ¸…é™¤ä¹‹å‰çš„ç¼–è¯‘
      configuration: option[:configuration], #æŒ‡å®šæ„å»ºAppçš„é…ç½®  Releaseã€Debugã€è‡ªå®šä¹‰ é»˜è®¤ä¸ºRelease
      export_method: "#{EXPORT_METHOD}", #æ‰“åŒ…æ–¹æ³• app-store, ad-hoc, development, enterprise, package é»˜è®¤app-store
      output_directory: "#{OUTPUT_DIRECTORY}", #è¾“å‡ºç›®å½• é»˜è®¤ä¸ºå½“å‰æ–‡ä»¶å¤¹
      output_name: "#{IPA_NAME}", #è¾“å‡ºåç§° åº”åŒ…å«æ–‡ä»¶æ‰©å±•å
      include_symbols: true, #æ˜¯å¦åŒ…å«è°ƒè¯•ç¬¦å·
      include_bitcode: true, #æ˜¯å¦å¼€å¯bitcode
      silent: true, #æ˜¯å¦éšè—æ‰“åŒ…æ—¶ä¸éœ€è¦çš„ä¿¡æ¯
      xcargs: 'DEBUG_INFORMATION_FORMAT="dwarf-with-dsym"', #é™„åŠ ä¸€äº›å‚æ•°ä¼ é€’ç»™xcodebuild  DWARFå¯ä»¥æé«˜ç¼–è¯‘é€Ÿåº¦
      export_xcargs: "-allowProvisioningUpdates", #è®¿é—®é’¥åŒ™ä¸² allowProvisioningUpdatesæ¥æ§åˆ¶è‡ªåŠ¨æ›´æ–°ç®¡ç†Provisoning Profileç­¾åè¯ä¹¦
      export_team_id: "#{TEAM_ID}", #æœ‰æ—¶éœ€è¦åœ¨å¯¼å‡º ipa æ–‡ä»¶æ—¶æŒ‡å®šå›¢é˜ŸID
      # skip_codesigning: true, #æ˜¯å¦æ— éœ€ä»£ç ç­¾åå³å¯æ„å»º
      # sdk: "iOS 15.0",         #åœ¨æ„å»ºé¡¹ç›®æ—¶ï¼Œä½¿ç”¨SDKä½œä¸ºåŸºç¡€SDKçš„åç§°æˆ–è·¯å¾„
      # codesigning_identity: "iPhone Distribution: SunApps GmbH", #è¦ä½¿ç”¨çš„ä»£ç ç­¾åæ ‡è¯†çš„åç§°ã€‚å®ƒå¿…é¡»å’Œåå­—å®Œå…¨åŒ¹é…
      # xcodebuild -help æŸ¥çœ‹-exportOptionsPlistå‚æ•°é¡¹
      export_options: {
        #  provisioningProfiles: {
        #    "#{APP_IDENTIFIER}" => "#{SIGN_ARCHIVE_DIR}/#{APP_IDENTIFIER}.#{EXPORT_METHOD}.mobileprovision"
        #  },
        # signingStyle: "manual", #ç­¾åæ–¹å¼ manualæ‰‹åŠ¨ç­¾å é»˜è®¤automaticè‡ªåŠ¨ç­¾å
        # thinning: "<none>",  #æ˜¯å¦ç˜¦èº«
      }
    )

    puts "\033[32mIPAåŒ…è·¯å¾„: #{IPA_PATH}\033[0m\n"

    #æ‰“å¼€ipaçš„å­˜æ”¾æ–‡ä»¶å¤¹
    #system "open ./#{OUTPUT_DIRECTORY}"

  end

  desc "App Storeå®¡æ ¸ä¸Šæ¶"
  lane :app_store do |options|
    # App Storeå®¡æ ¸ä¸Šæ¶ä¹‹å‰çš„æ‰§è¡Œä»»åŠ¡
    app_store_before_do()

    puts "\033[32må¼€å§‹è‡ªåŠ¨æäº¤App Storeå®¡æ ¸ä¸Šæ¶\033[0m\n"

    upload_to_app_store(
      ipa: options[:ipa], # ipaåŒ…è·¯å¾„
      app_version: "#{APP_VERSION}", # ç‰ˆæœ¬å·
      submit_for_review: options[:submit_for_review], # æ˜¯å¦è‡ªåŠ¨æäº¤å®¡æ ¸
      automatic_release: options[:automatic_release], # æ˜¯å¦å®¡æ ¸é€šè¿‡åç«‹åˆ»ä¸Šæ¶å‘å¸ƒ
      force: true, # è®¾ç½®true ä¼šè·³è¿‡é¢„è§ˆé¡µé¢ ç›´æ¥ä¸Šæ¶ å…¨è‡ªåŠ¨CIæœåŠ¡éœ€è¦true
      skip_metadata: false, # æ˜¯å¦è·³è¿‡ä¸Šä¼ å…ƒæ•°æ® trueæ—¶å€™release_notesæ— æ•ˆ
      metadata_path: nil,
      skip_screenshots: true, # æ˜¯å¦è·³è¿‡ä¸Šä¼ æˆªå›¾
      skip_binary_upload: false, # æ˜¯å¦è·³è¿‡ä¸Šä¼ ipaæˆ–pkgåˆ°App Store Connect
      run_precheck_before_submit: true, # æ˜¯å¦åœ¨æäº¤åˆ°app reviewä¹‹å‰è¿è¡Œprecheck å®¡æ ¸è§„åˆ™æ£€æµ‹ ä»¥é¿å…è¢«æ‹’ç»
      precheck_include_in_app_purchases: false, # æ˜¯å¦é¢„å…ˆæ£€æŸ¥åº”ç”¨å†…è´­ä¹°
      reject_if_possible: true, # æ‹’ç»å…ˆå‰æäº¤çš„æ„å»ºï¼ˆå¦‚æœå¤„äºå¯èƒ½çš„çŠ¶æ€ï¼‰
      skip_app_version_update: false, # ä¸è¦åˆ›å»ºæˆ–æ›´æ–°æ­£åœ¨å‡†å¤‡æäº¤çš„åº”ç”¨ç¨‹åºç‰ˆæœ¬
      overwrite_screenshots: false, # åœ¨ä¸Šä¼ æ–°çš„æˆªå›¾ä¹‹å‰ï¼Œè¯·å…ˆæ¸…é™¤æ‰€æœ‰å…ˆå‰ä¸Šä¼ çš„æˆªå›¾
      phased_release: false, # æ˜¯å¦å¯ç”¨iTCçš„åˆ†é˜¶æ®µå‘å¸ƒåŠŸèƒ½ ç°åº¦å‘å¸ƒ
      # App Storeåº”ç”¨å‘å¸ƒå˜æ›´æ—¥å¿—
      release_notes: {
        'default' => options[:release_note],
        'zh-Hans' => options[:release_note] # "Fastlaneè‡ªåŠ¨åŒ–å‘å¸ƒ #{Time.now.strftime("%Y-%m-%d %H:%M")}"
        #'en-US' => "Release By Fastlane",
      },
      # App Store åº”ç”¨å®¡æ ¸å°ç»„çš„è”ç³»ä¿¡æ¯ appå®¡æ ¸ä¿¡æ¯
      app_review_information: {
        first_name: options[:first_name],
        last_name: options[:last_name],
        phone_number: options[:phone_number],
        email_address: options[:email_address],
        demo_user: options[:demo_user], # Appæµ‹è¯•å®¡æ ¸è´¦å·
        demo_password: options[:demo_password], # Appæµ‹è¯•å®¡æ ¸å¯†ç 
        notes: ""
      }
    )

  end

  desc "æ‰“åŒ…ä¹‹å‰è¦æ‰§è¡Œçš„ä»»åŠ¡"
  private_lane :package_before_do do |options|

=begin
    #æ‰§è¡Œ pod install
    cocoapods(
      clean_install: false,
      repo_update: true,
    # podfile: "./CustomPodfile"
    )
=end

    # å°†è¯ä¹¦ä»è¾“å…¥æ–‡ä»¶å¯¼å…¥é’¥åŒ™ä¸²
=begin
    import_certificate(
      certificate_path: "#{SIGN_ARCHIVE_DIR}/XNT8SK8MB.cer", # .ceræˆ–.p12
      certificate_password: ENV["MACOS_USER_PASSWORD"] || "default",
      keychain_path: ENV['HOME'] + "/Library/Keychains/login.keychain",
    )
=end
    # è¯ä¹¦ç®¡ç†  æ³¨æ„matchæ–°åˆ›å»ºè¯ä¹¦ä¼šå¯¼è‡´å·²å­˜åœ¨çš„è¯ä¹¦ä¼šè¢«æ’¤é”€å¤±æ•ˆ
    # match(git_url: "http://panweiji:panweijikeji666@git.panweijikeji.com/health/certificates",
    #       git_branch: "master",
    #       type: "adhoc", # appstore
    #       app_identifier: #{APP_IDENTIFIER}, #è‹¥åŒå·¥ç¨‹ä¸‹æœ‰å¤šä¸ª,åˆ™ç”¨["bundleId1","bundleId2"]
    #       readonly: true
    # )
    # sync_code_signing(type:"appstore", readonly: is_ci)

    #è‡ªåŠ¨åˆ›å»ºç®¡ç†iOSä»£ç ç­¾åè¯ä¹¦ å°†ç¡®ä¿ä½ åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šå®‰è£…äº†æœ‰æ•ˆçš„è¯ä¹¦åŠå…¶ç§é’¥
    #cert
    #sighæ˜¯ç”¨æ¥åˆ›å»ºã€æ›´æ–°ã€ä¸‹è½½ã€ä¿®å¤Provisioning Profileçš„å·¥å…· æ¯æ¬¡è¿è¡Œæ—¶åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶ ç¡®ä¿ä½ åœ¨æœ¬åœ°å®‰è£…äº†ä¸è¯ä¹¦ç›¸åŒ¹é…çš„æœ‰æ•ˆé…ç½®æ–‡ä»¶
    #sigh(adhoc: true, force: true,
    #    cert_id: "xxxxxx", #é€‰æ‹©å“ªä¸ªå‘å¸ƒè¯ä¹¦é…ç½®
    #    filename: "debug.mobileprovision" #ä¸‹è½½çš„æè¿°æ–‡ä»¶åå­—ï¼ŒåŒåå°±ä¼šè‡ªåŠ¨è¦†ç›–
    # )

    # é‡æ–°åˆ›å»ºä¸å…±äº«çš„Xcodeé¡¹ç›®æ–¹æ¡ˆ
    # recreate_schemes(project: "#{XC_PROJECT}")

    # é…ç½®Xcodeçš„Codesigningé€‰é¡¹
    update_code_signing_settings(
      use_automatic_signing: true, # å¼€å¯è‡ªåŠ¨ç­¾å
      path: "#{XC_PROJECT}"
    )

    # æ›´æ–°Xcodeå¼€å‘å›¢é˜ŸID
    update_project_team(
      teamid: "#{TEAM_ID}",
      path: "#{XC_PROJECT}",
      targets: "#{SCHEME}" # è¦æ›´æ–°çš„ç›®æ ‡çš„åç§°
    )

    # è‡ªåŠ¨åœ¨Apple Developer Portalåˆ›å»ºBundleIdentifier
    # App Store Connect APIæ–¹å¼æš‚æ—¶ä¸æ”¯æŒproduceè¡Œä¸º   Apple IDæ–¹å¼éƒ¨åˆ†æ”¯æŒ
=begin
    produce(
      username: "#{APPLE_ID}",
      app_identifier: "#{APP_IDENTIFIER}",
      skip_itc: true # è·³è¿‡åœ¨ App Store Connect ä¸Šåˆ›å»ºåº”ç”¨ç¨‹åº
    )
=end
    # æ›´æ–°BundleIdentifier
    # set_info_plist_value(path: "Info.plist", key: "CFBundleIdentifier", value: APP_IDENTIFIER)
=begin
    update_app_identifier(
      xcodeproj: "#{XC_PROJECT}", # Optional path to xcodeproj, will use the first .xcodeproj if not set
      plist_path: "Info.plist", # Path to info plist file, relative to xcodeproj
      app_identifier: "#{APP_IDENTIFIER}" # The App Identifier
    )
=end

    # æ›¿æ¢Xcodeå·¥ç¨‹å†…çš„ provisioning æ–‡ä»¶
=begin
    update_project_provisioning(
      xcodeproj: "#{XC_PROJECT}",
      target_filter: ".*Unity.*", # matches name or type of a target
      profile: "#{SIGN_ARCHIVE_DIR}/#{APP_IDENTIFIER}.#{EXPORT_METHOD}.mobileprovision", # optional if you use sigh
      build_configuration: "#{PACKAGING_TYPE}",
      code_signing_identity: "#{EXPORT_METHOD == "app-store" || EXPORT_METHOD == "ad-hoc" ? "iPhone Distribution" : "Apple Development: jiaru Yin (7326H3B9LC)" }"
    )
=end

    # è§£é”å·²å­˜åœ¨çš„keychainï¼Œå¹¶æ·»åŠ åˆ°keychainé’¥åŒ™ä¸²æœç´¢åˆ—è¡¨ä¸­
    unlock_keychain(
      path: ENV['HOME'] + "/Library/Keychains/login.keychain",
      password: ENV['MACOS_USER_PASSWORD']
    )

  end

  desc "App Storeå®¡æ ¸ä¸Šæ¶ä¹‹å‰è¦æ‰§è¡Œçš„ä»»åŠ¡"
  private_lane :app_store_before_do do |options|

    #åˆ›å»ºäº§å“ä¿¡æ¯åˆ°iTunes Connect(iTC)æˆ–è€…Apple Developer Center(ADC)
    # produce(
    #   app_name: "#{APP_NAME}",
    #   app_identifier: "#{APP_IDENTIFIER}",
    #   language: 'zh-Hans',
    #   app_version: '1.0.0',
    #   sku: "#{APP_IDENTIFIER}"
    #     # Optional ã€ App services can be enabled during app creation
    #     enable_services: {
    #       access_wifi: "on",
    #       apple_pay: "on",
    #       associated_domains: "on",
    #       push_notification: "on",
    #      }
    # )

    # Appleå®£å¸ƒï¼Œä» 2020 å¹´ 12 æœˆ 8 æ—¥èµ·ï¼ŒApp Store å°†å¼€å§‹æ˜¾ç¤ºæœ‰å…³åº”ç”¨éšç§æƒ¯ä¾‹çš„è¯¦ç»†ä¿¡æ¯
    # App Storeä¸Šä¼ åº”ç”¨ç¨‹åºéšç§è¯¦ç»†ä¿¡æ¯
=begin
    upload_app_privacy_details_to_app_store(
      username: "#{APPLE_ID}",
      team_name: "Your Team Name",
      app_identifier: "#{APP_IDENTIFIER}",
      json_path: "fastlane/app_privacy_details.json"
    )
=end

    # æ³¨æ„shå‘½ä»¤è·å–çš„ç»“æœå­—ç¬¦ä¸²å­˜åœ¨æ¢è¡Œé—®é¢˜
    #IPA_FULL_PATH = sh("cd .. && find $PWD/#{OUTPUT_DIRECTORY}/*.ipa")
    #IPA_FULL_NAME = sh("cd .. && cd #{OUTPUT_DIRECTORY} && find *.ipa")

    # é¢„æ£€æµ‹å®¡æ ¸ä¸Šæ¶æ¡ä»¶å’Œè§„åˆ™
    # precheck(include_in_app_purchases: false)

  end

  desc "æ¸…ç©ºiOSæ„å»ºäº§ç‰©"
  lane :clean_build_artifact do
    #iOSæ‰“åŒ…å‰æ¸…ç©ºæ„å»ºäº§ç‰© å‡å°‘ç£ç›˜ç©ºé—´
    clean_build_artifacts # Deletes files created as result of running gym, cert, sigh or download_dsyms
    clear_derived_data # Deletes the Xcode Derived Data
  end

  desc "ä»£ç è´¨é‡æ‰«æ"
  lane :code_lint do
    puts "\033[32må¼€å§‹ä»£ç è´¨é‡æ‰«æ\033[0m\n"
    swiftlint(
      output_file: "sonar-reports/sonar-swiftlint.txt",
      ignore_exit_status: true
    )
    sonar
  end

  desc "è‡ªåŠ¨åŒ–æµ‹è¯•"
  lane :test do
    puts "\033[32må¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•\033[0m\n"
    # scan(scheme: "#{SCHEME}")
    scan(
      clean: true,
      #devices: ["iPhone 6s","iPhone X"],
      workspace: "#{XC_WORKSPACE}",
      scheme: "#{SCHEME}",
      code_coverage: true,
      output_directory: "./test_output",
      output_types: "html,junit"
    )
    slather(
      cobertura_xml: true,
      proj: "#{XC_PROJECT}",
      workspace: "#{XC_WORKSPACE}",
      output_directory: "./test_output",
      scheme: "#{SCHEME}",
      jenkins: true,
      ignore: [array_of_docs_to_ignore]
    )
  end

  desc "Gitä¸Šä¼ å®ŒååŠ è½½æ‰€æœ‰çš„çº¿ä¸Šè¯ä¹¦å’Œé…ç½®æ–‡ä»¶"
  lane :match_all do
    sh "fastlane match development --readonly"
    sh "fastlane match adhoc --readonly"
    sh "fastlane match appstore --readonly"
  end

  after_all do |lane|
    # åœ¨MacOS é€šçŸ¥æ å‘é€é€šçŸ¥
    # notification(subtitle: "iOSæ‰“åŒ…æˆåŠŸ", message: "æˆåŠŸéƒ¨ç½²æ–°iOSåº”ç”¨ç¨‹åº")
  end

  #åœ¨æ‰§è¡Œä»»æ„ç¯å¢ƒæŠ¥é”™éƒ½ä¼šä¸­æ­¢å¹¶æ‰§è¡Œä¸€æ¬¡
  error do |lane, exception|
    UI.message(exception.message)
    puts "\033[40;31m ğŸ‘‰ Fastlaneå¼‚å¸¸æŠ¥é”™ä¿¡æ¯: " + exception.message + "\033[0m\n"
    # ç‰ˆæœ¬å·æˆ–æ„å»ºå·ä¸çº¿ä¸Šå†²çª exception.messageåŒ…å« A relationship value is not acceptable for the current resource state
    # è‡ªåŠ¨ä¿®å¤mobileprovisionæ‰“åŒ…ç­¾åæ–‡ä»¶ è‡ªåŠ¨ä¿®å¤æ‰€æœ‰ç°æœ‰çš„å·²è¿‡æœŸæˆ–æ— æ•ˆçš„é…ç½®æ–‡ä»¶ éœ€è¦ä¸¤æ­¥éªŒè¯
    # p12è¯ä¹¦å’Œmobileprovisionæ–‡ä»¶å…³ç³»å¯¹åº”é”™ä¹±æ²¡æœ‰åŒ¹é…ä¸Šä¼šå¯¼è‡´æŠ¥é”™å¦‚ä¸‹å…³é”®å­—:
    # error: No profiles for 'id' were found: Xcode couldn't find any iOS App Development provisioning profiles matching
    # sh "fastlane sigh repair" # ä¿®å¤mobileprovisionæ–‡ä»¶æ–‡æ¡£ï¼šhttps://docs.fastlane.tools/actions/sigh/
    # æ¸…ç©ºæ„å»ºäº§ç‰©
    # clean_build_artifact()
    # error: Provisioning profile "iOS Team Provisioning Profile: *" doesn't support or include
    # sh " cd " + ENV['HOME'] + "/Library/MobileDevice/Provisioning Profiles && pwd && rm -f *.mobileprovision "
  end

end
