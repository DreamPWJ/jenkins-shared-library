# Author: æ½˜ç»´å‰
# Description: è‡ªå®šä¹‰æ ¸å¿ƒFastlaneé…ç½®æ–‡ä»¶ å®ç°åŸç”ŸAndroidå…¨è‡ªåŠ¨CI/CDæµæ°´çº¿

import "../GeneralFastfile"

default_platform(:android)

# apkå®‰è£…åŒ…è·¯å¾„
APK_PATH = ""

platform :android do

  #åœ¨æ‰§è¡Œlaneä¹‹å‰åªæ‰§è¡Œä¸€æ¬¡
  before_all do |lane, options|

    # ç¡®ä¿è¿è¡Œå¿«é€Ÿé€šé“æ—¶fastlaneå·¥å…·æ˜¯æœ€æ–°çš„
    # update_fastlane
    # å¦‚æœæœ‰æœªæäº¤çš„gitæ›´æ”¹ï¼Œåˆ™ä¼šå¼•å‘å¼‚å¸¸
    # sure_git_status_clean
    # å®‰è£…æ‰€æœ‰æ’ä»¶å’Œæ›´æ–°æ‰€æœ‰æ’ä»¶
    # sh "fastlane install_plugins"
    # sh "fastlane update_plugins"

  end

  desc "è‡ªåŠ¨åŒ–æµ‹è¯•"
  lane :test do
    puts "\033[32må¼€å§‹è‡ªåŠ¨åŒ–å•å…ƒæµ‹è¯•\033[0m\n"
    gradle(task: "test")
  end

  desc "Androidæ‰“åŒ…"
  lane :package do |options|
    puts "\033[32må¼€å§‹Androidæ‰“åŒ…APK\033[0m\n"

    if options[:packaging_type].include?('Release')

    else
      if options[:is_aab]

      end
    end

=begin
    channelName = options[:channel]
    if channelName.nil?
      channelName = "official"
    end
=end

    # æ¸…é™¤ä¹‹å‰çš„ç¼–è¯‘
    gradle(
      task: 'clean'
    )

    # æ ¹æ®éœ€è¦è°ƒæ•´build_typeå’Œflavorå‚æ•°ï¼Œä»¥ä¾¿ä¸ºæ‚¨çš„è®¾ç½®æ„å»ºæ­£ç¡®çš„APK
    # flavor: ""
    # tasks: ["assembleDebug", "bundleDebug"]

    gradle(
      task: options[:is_aab] ? 'bundle' : 'assemble', # aabæ ¼å¼ç”¨bundleã€apkæ ¼å¼ç”¨assemble
      build_type: options[:packaging_type], # æ„å»ºç±»å‹Debug/Release ä¹Ÿå¯è‡ªå®šä¹‰ç¯å¢ƒç±»å‹
      flags: "--no-daemon", # è¦ä¼ é€’ç»™ gradle å‘½ä»¤çš„æ‰€æœ‰å‚æ•°æ ‡å¿— --no-daemonè§£å†³jenkinså¹¶å‘æ‰§è¡Œä¼šå°†gradleæ€æ‰
    )

     # ä¸ºAndroidåº”ç”¨ç­¾å: https://developer.android.com/studio/publish/app-signing

    if options[:is_aab]
      APK_PATH = Actions.lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]
      puts "\033[32mAABåŒ…è·¯å¾„: #{APK_PATH}\033[0m\n"
    else
      APK_PATH = Actions.lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
      puts "\033[32mAPKåŒ…è·¯å¾„: #{APK_PATH}\033[0m\n"
    end

    # apkåŒ…é‡å‘½å
    # NEW_APK_NAME "#{APK_PATH}".split('/')[-1]
    # sh("mv #{APK_PATH} #{APK_PATH}/#{NEW_APK_NAME}")

    #adbå‘½ä»¤ å¯è·å–APKç›¸å…³ä¿¡æ¯
=begin
    adb(
      command: "shell ls"
    )
=end

  end

  desc "è‡ªåŠ¨æå®¡ä¸Šæ¶åä¸ºApp Galleryåº”ç”¨å•†åº—"
  lane :huawei_app_gallery do |options|
    puts "\033[32må¼€å§‹è‡ªåŠ¨ä¸Šä¼ åä¸ºApp Galleryåº”ç”¨å•†åº—ğŸš€\033[0m\n"
    # githubåœ°å€: https://github.com/shr3jn/fastlane-plugin-huawei_appgallery_connect
    # fastlane add_plugin huawei_appgallery_connect ä¸ gem 'fastlane-plugin-huawei_appgallery_connect'
=begin
    Dir.chdir("app/build/outputs/apk/") do

    end
=end
    # å½“å‰ç‰ˆæœ¬å˜æ›´è®°å½•å­˜å‚¨æ–‡ä»¶åç§°
    current_changelog_file = "CURRENT_VERSION_CHANGELOG.md"
    sh("cd .. && echo '" + options[:release_note] + "' > " + current_changelog_file)

    huawei_appgallery_connect(
      client_id: ENV['HUAWEI_APP_GALLERY_CLIENT_ID'], # æ³¨æ„è®¾ç½®å›¢é˜Ÿæ¨¡å¼çš„APIè¿æ¥æ‰ç”Ÿæ•ˆ
      client_secret: ENV['HUAWEI_APP_GALLERY_CLIENT_SECRET'], # è®¾ç½®åœ°å€: AppGallery Connect API åˆ›å»º
      app_id: options[:app_id], # åº”ç”¨id
      apk_path: options[:apk_path], # åº”ç”¨åŒ…è·¯å¾„
      submit_for_review: true, # æ˜¯å¦æäº¤å®¡æ ¸
      is_aab: options[:is_aab], # æ˜¯å¦aabæ–°æ ¼å¼
      changelog_path: current_changelog_file, # åº”ç”¨æ—¥å¿—å¤‡æ³¨ "Fastlaneè‡ªåŠ¨åŒ–å‘å¸ƒ #{Time.now.strftime("%Y-%m-%d %H:%M")"
    # release time to release app on specific date
    # release_time: "2020-12-25T07:05:15+0000", # é»˜è®¤å®¡æ ¸é€šè¿‡ç«‹å³ä¸Šæ¶
    # privacy_policy_url: "https://example.com",
    # For phase wise release: set these parameters
    # phase_wise_release: true,
    # phase_release_description: options[:release_note]
    )

  end

  desc "è·å–åä¸ºApp Galleryå•†åº—åº”ç”¨ä¿¡æ¯"
  lane :get_huawei_app_info do |options|
    app_info = huawei_appgallery_connect_get_app_info(
      client_id: ENV['HUAWEI_APP_GALLERY_CLIENT_ID'],
      client_secret: ENV['HUAWEI_APP_GALLERY_CLIENT_SECRET'],
      app_id: options[:app_id] # åº”ç”¨id
    )
    # åˆ¤æ–­åº”ç”¨æ˜¯å¦å·²ç»æäº¤å®¡æ ¸æˆåŠŸï¼ˆreleaseStateä¸º4ï¼‰
    p app_info
  end

  desc "è‡ªåŠ¨æå®¡ä¸Šæ¶å°ç±³åº”ç”¨å•†åº—"
  lane :xiaomi_market do |options|
    puts "\033[32må¼€å§‹è‡ªåŠ¨ä¸Šä¼ å°ç±³åº”ç”¨å•†åº—ğŸš€\033[0m\n"
    # githubåœ°å€: https://github.com/istobran/fastlane-plugin-xiaomi_devupload
    # fastlane add_plugin xiaomi_devupload  ä¸ gem 'fastlane-plugin-xiaomi_devupload'
      xiaomi_devupload(
        request_data: {
          :userName => options[:user_name], # ç”¨æˆ·åï¼Œåœ¨å°ç±³å¼€å‘è€…ç«™ç™»å½•çš„é‚®ç®±
          :synchroType => 1, # æ›´æ–°ç±»å‹ï¼š0=æ–°å¢ï¼Œ1=æ›´æ–°åŒ…ï¼Œ2=å†…å®¹æ›´æ–°
          :appInfo => {
            :appName => options[:app_name], # åº”ç”¨åç§°
            :packageName => options[:package_name], # åº”ç”¨åŒ…å
            :updateDesc => options[:desc], # æ›´æ–°ä¿¡æ¯
          },
        },
        apk_path: options[:apk_path], # ApkåŒ…ï¼Œæ›´æ–°ç±»å‹ä¸ºæ–°å¢å’Œæ›´æ–°æ—¶å¿…ä¼  é»˜è®¤GRADLE_APK_OUTPUT_PATH
        # åœ¨å°ç±³å¼€æ”¾å¹³å°å…·ä½“åº”ç”¨çš„è‡ªåŠ¨åŒ–ä¸Šä¼ å…¥å£å†…è·å– ç°é˜¶æ®µæ¯ä¸ªåº”ç”¨éƒ½å”¯ä¸€çš„è¯ä¹¦å’Œç§é’¥
        public_key_path: File.expand_path('xiaomi.'+options[:package_name]+'.cer'), # å…¬é’¥æ–‡ä»¶è·¯å¾„ fastlaneç›®å½•ä¸‹
        private_key: options[:private_key] # ç§é’¥å­—ç¬¦ä¸²
      )
  end

  desc "è‡ªåŠ¨æå®¡ä¸Šæ¶è°·æ­ŒPlay Storeåº”ç”¨å•†åº—"
  lane :google_play_store do |options|
    # æ–‡æ¡£åœ°å€: https://docs.fastlane.tools/actions/upload_to_play_store/
    puts "\033[32må¼€å§‹è‡ªåŠ¨ä¸Šä¼ è°·æ­ŒPlay Storeåº”ç”¨å•†åº—\033[0m\n"
    upload_to_play_store
  end

  desc "æ–°æ ¼å¼aabåŒ…è½¬æˆç»Ÿä¸€çš„apkåŒ…"
  lane :aab_to_apk do |options|
    # å› ä¸ºaabåŒ…ä¸èƒ½ç›´æ¥å®‰è£… æ‰€ä»¥è½¬æ¢æˆapkæ–¹ä¾¿å®‰è£…
    # githubåœ°å€: https://github.com/MartinGonzalez/fastlane-plugin-bundletool/
    # fastlane add_plugin bundletool  ä¸  gem 'fastlane-plugin-bundletool'
    bundletool(
      #bundletool_version: '1.8.0',
      aab_path: options[:aab_path],
      apk_output_path: options[:apk_output_path],
      verbose: true
    )
  end

=begin
  desc "è°·æ­ŒFirebase Test Labè‡ªåŠ¨åŒ–æµ‹è¯•"
  lane :firebase_test_lab_for_android do |options|
  # githubåœ°å€: https://github.com/cats-oss/fastlane-plugin-firebase_test_lab_android
  # fastlane add_plugin firebase_test_lab_android   ä¸  gem 'fastlane-plugin-firebase_test_lab_android'
  # ä¸Šä¼  Firebase Test Lab è‡ªåŠ¨åŒ–æµ‹è¯•
  firebase_test_lab_android(
    project_id: "composite-watch-331806",                           # Your Firebase project name.
    gcloud_service_key_file: "fastlane/client-secret.json",         # File path containing the gcloud auth key.
    # gcloud_components_channel: "beta",                            # If you use gcloud component channel option (alpha/beta).
    type: "robo",                                                   # Optional: Test type (robo/instrumentation).
    devices: [                                                      # Devices
      {
        model: "Nexus6P",
        version: "23",
        locale: "ja_JP",
        orientation: "portrait"
      },
      {
        model: "Pixel3",
        version: "28"
      }
    ],
    app_apk: "app-debug.apk",                                       # The path for your android app apk.
    # app_test_apk: "app-test.apk",                                 # The path for your android instrumentation test apk.
    # use_orchestrator: false,                                      # If you use orchestrator when set instrumentation test.
    console_log_file_name: "fastlane/console_output.log",
    timeout: "60s",
    firebase_test_lab_results_bucket: "firebase_test_bucket"  # If you want to naming bucket of GCS
    # firebase_test_lab_results_dir: "firebase_test_dir",      # If you want to naming results of GCS. (Maybe don't need it.)
  end
=end

  after_all do |lane|
    # åœ¨MacOS é€šçŸ¥æ å‘é€é€šçŸ¥
    # notification(subtitle: "Androidæ‰“åŒ…æˆåŠŸ", message: "æˆåŠŸéƒ¨ç½²æ–°Androidåº”ç”¨ç¨‹åº")
  end

  #åœ¨æ‰§è¡Œä»»æ„ç¯å¢ƒæŠ¥é”™éƒ½ä¼šä¸­æ­¢å¹¶æ‰§è¡Œä¸€æ¬¡
  error do |lane, exception|
    UI.message(exception.message)
    puts "\033[40;31m ğŸ‘‰ Fastlaneå¼‚å¸¸æŠ¥é”™ä¿¡æ¯: " + exception.message + "\033[0m\n"
  end

end
