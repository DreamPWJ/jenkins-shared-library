# Author: 潘维吉
# Description: 执行云原生K8S七层负载

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gray-release-canary
  namespace: default
  # Annotations属性文档:  https://github.com/kubernetes/ingress-nginx/blob/main/docs/user-guide/nginx-configuration/annotations.md
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    acme.cert-manager.io/http01-edit-in-place: "true"

    # 开启金丝雀Canary。
    nginx.ingress.kubernetes.io/canary: "true"
    # Http Header请求头为version。
    nginx.ingress.kubernetes.io/canary-by-header: "version"
    # 请求头version=v2.0.0时，请求才会被路由到新版本服务中。
    nginx.ingress.kubernetes.io/canary-by-header-value: "v2.0.0"
    #nginx.ingress.kubernetes.io/canary-by-header-pattern: ""
    #nginx.ingress.kubernetes.io/canary-by-cookie: ""
    # 在满足上述匹配规则的基础上仅允许百分比的流量会被路由到新版本服务中。
    nginx.ingress.kubernetes.io/canary-weight: "100"

    # 开启跨域
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-max-age: "64800"
    nginx.ingress.kubernetes.io/cors-allow-methods: "PUT, GET, POST, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    # 数据请求超时时间
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    # 负载均衡算法 如ip_hash
    nginx.ingress.kubernetes.io/upstream-hash-by: "$host"
    # Session保持配置
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-mode: "persistent"
    nginx.ingress.kubernetes.io/session-cookie-name: "route"
    # 后端大文件上传大小
    nginx.ingress.kubernetes.io/client-body-buffer-size: 1024m
    nginx.ingress.kubernetes.io/proxy-max-temp-file-size: 2048m
    # 数据传输大小
    nginx.ingress.kubernetes.io/proxy-body-size: 1024m
    # 配置是否同时支持http和https访问应用
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

spec:
  ingressClassName: k8s-ingress
  tls: # TLS安全
    - hosts:
        - panweiji.com
    - secretName: panweiji-tls-secret # Secret证书存储名称 存放HTTPS证书

  rules:
    - host: panweiji.com
      http:
        paths:
          - path: /
            backend:
              #服务名称
              service:
                name: {APP_NAME}-service
              #服务端口
                port:
                  number: {HOST_PORT}
            pathType: Prefix


# 获取Ingress
# kubectl get ing
# 删除Ingress
# kubectl delete ingress ingress-name